---
title: "codeProject"
output: html_document
date: "2025-06-13"
---

```{r}
install.packages("MASS")
install.packages("nnet")  # אם לא מותקן

```


```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(MASS)
library(nnet)
```

```{r}

CarsAccidentsData = read.csv("data/CarsAccidentsData.csv")
notification_cols <- c("FRNT_COLLISION_WARNING", "LANE_DEPARTURE_WARNING", "BLIND_SPOT_DETECTION")

```

```{r}

set.seed(123)  # לשחזור תוצאה, אפשר לשנות או להסיר


CarsAccidentsData <- CarsAccidentsData %>%
  mutate(
    DEFORMED_LEVEL = case_when(
      DEFORMEDNAME == "No Damage" ~ 1,
      DEFORMEDNAME == "Minor Damage" ~ 2,
      DEFORMEDNAME == "Functional Damage" ~ 3,
      DEFORMEDNAME == "Disabling Damage" ~ 4,
      TRUE ~ NA_real_ 
    )
  )


CleanedData <- CarsAccidentsData %>%
  mutate(across(all_of(notification_cols), ~ ifelse(.x == 2, sample(c(0, 1), size = length(.x), replace = TRUE), .x)))

CleanedData <- CleanedData %>% dplyr::select(-AUTO_CRASH_NOTIFICATION)
CleanedData$notification_count <- rowSums(CleanedData[, notification_cols] == 1)
```

```{r}

FilteredData <- CleanedData %>%
  filter(
    DR_DRINK == 0,                                
    VSURCONDNAME == "Dry",                        
    !grepl("(?i)Yes", SPEEDRELNAME),              
    !grepl("(?i)Unknown", SPEEDRELNAME),          
    L_STATUSNAME == "Valid",
    DEFORMEDNAME %in% c("Disabling Damage", "Functional Damage", "Minor Damage", "No Damage")
  )
```

```{r}
# Summarize number of accidents by notification_count
accidents_by_notifications <- FilteredData %>%
  group_by(notification_count) %>%
  summarise(num_accidents = n())

# Plot the results
ggplot(accidents_by_notifications, aes(x = factor(notification_count), y = num_accidents)) +
  geom_col() +
  labs(
    title = "Number of Accidents by Number of Safety Systems",
    x = "Number of Safety Systems",
    y = "Number of Accidents"
  ) +
  theme_minimal()
```


```{r}
# Expected proportions under binomial distribution (n=3, p=0.5)
expected_probs <- dbinom(0:3, size = 3, prob = 0.5)

# Add expected probabilities to the summary table
accidents_by_notifications$expected_prob <- expected_probs[accidents_by_notifications$notification_count + 1]  # +1 because R is 1-indexed

# Normalize actual accident counts by expected probabilities
accidents_by_notifications$normalized_accidents <- accidents_by_notifications$num_accidents / accidents_by_notifications$expected_prob

# Plot the normalized accidents
ggplot(accidents_by_notifications, aes(x = factor(notification_count), y = normalized_accidents)) +
  geom_col() +
  labs(
    title = "Normalized Accident Counts by Number of Safety Systems",
    x = "Number of Safety Systems",
    y = "Normalized Accident Count"
  ) +
  theme_minimal()

```

```{r}

# Step 2: create combo column like "101"
FilteredData$combo <- apply(FilteredData[, notification_cols], 1, paste0, collapse = "")

# Step 3: count accidents per combination
combo_summary <- FilteredData %>%
  group_by(combo) %>%
  summarise(num_accidents = n(), .groups = "drop")

# Step 4: generate all possible combinations and theoretical probabilities (assuming p = 0.5)
p <- 0.5
all_combos <- expand.grid(BLIND_SPOT_DETECTION = c(0, 1),
                          FRNT_COLLISION_WARNING = c(0, 1),
                          LANE_DEPARTURE_WARNING = c(0, 1)) %>%
  mutate(combo = paste0(BLIND_SPOT_DETECTION, FRNT_COLLISION_WARNING, LANE_DEPARTURE_WARNING)) %>%
  rowwise() %>%
  mutate(expected_prob = prod(c_across(everything()[1:3]) * p + (1 - c_across(everything()[1:3])) * (1 - p))) %>%
  ungroup()

# Step 5: merge with real data and normalize
final <- left_join(all_combos[, c("combo", "expected_prob")], combo_summary, by = "combo") %>%
  mutate(num_accidents = replace_na(num_accidents, 0),
         normalized = num_accidents / expected_prob)

# Step 6: plot raw accident counts
ggplot(final, aes(x = combo, y = num_accidents)) +
  geom_col() +
  labs(
    title = "Accidents per Safety System Combination",
    x = "Safety System Combination (BFD)",
    y = "Number of Accidents"
  ) +
  theme_minimal()

# Step 7: plot normalized accident counts
ggplot(final, aes(x = combo, y = normalized)) +
  geom_col() +
  labs(
    title = "Normalized Accidents per Safety System Combination",
    x = "Safety System Combination (BFD)",
    y = "Normalized Accident Count"
  ) +
  theme_minimal()
```


Ohad's first way for the regression model, i took from the NotificationsPrecent the precentges of the chance that each system will be in the vehicle and i make it the coeffeintion.
```{r}

notification_precent_data = read.csv("data/NotificationsPrecent.csv")

no_systems_coef = notification_precent_data[2,"X0"] / 100
just_lane_coef = notification_precent_data[2,"Just.Lane"] / 100
just_front_coef = notification_precent_data[2,"Just.Front"] / 100
just_blind_coef = notification_precent_data[2,"Just.Blind"] / 100


FilteredData <- FilteredData %>%
  mutate(
    systems_sum = FRNT_COLLISION_WARNING + LANE_DEPARTURE_WARNING + BLIND_SPOT_DETECTION,
    Total_Score = 
      FRNT_COLLISION_WARNING * just_front_coef +
      LANE_DEPARTURE_WARNING * just_lane_coef +
      BLIND_SPOT_DETECTION * just_blind_coef +
      if_else(systems_sum == 0, no_systems_coef, 0)
  )


model_score <- polr(as.factor(DEFORMED_LEVEL) ~ Total_Score, data = FilteredData, Hess = TRUE)
summary(model_score)


```


Ohad's second way, like we know from the regression course
```{r}


# נניח שכאן כבר הגדרת את DEFORMED_LEVEL כ-1–4

# שלב 1: כל מערכת בנפרד
model_front <- polr(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING, data = FilteredData, Hess = TRUE)
model_lane <- polr(as.factor(DEFORMED_LEVEL) ~ LANE_DEPARTURE_WARNING, data = FilteredData, Hess = TRUE)
model_blind <- polr(as.factor(DEFORMED_LEVEL) ~ BLIND_SPOT_DETECTION, data = FilteredData, Hess = TRUE)

# שלב 2: זוגות של מערכות
model_front_lane <- polr(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + LANE_DEPARTURE_WARNING, data = FilteredData, Hess = TRUE)
model_front_blind <- polr(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + BLIND_SPOT_DETECTION, data = FilteredData, Hess = TRUE)
model_lane_blind <- polr(as.factor(DEFORMED_LEVEL) ~ LANE_DEPARTURE_WARNING + BLIND_SPOT_DETECTION, data = FilteredData, Hess = TRUE)

# שלב 3: כל שלושת המערכות
model_all <- polr(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + LANE_DEPARTURE_WARNING + BLIND_SPOT_DETECTION, data = FilteredData, Hess = TRUE)

# תצוגה מסודרת של כל הסיכומים
cat("Model: Front only\n")
print(summary(model_front))
cat("\n\nModel: Lane only\n")
print(summary(model_lane))
cat("\n\nModel: Blind only\n")
print(summary(model_blind))

cat("\n\nModel: Front + Lane\n")
print(summary(model_front_lane))
cat("\n\nModel: Front + Blind\n")
print(summary(model_front_blind))
cat("\n\nModel: Lane + Blind\n")
print(summary(model_lane_blind))

cat("\n\nModel: All three systems\n")
print(summary(model_all))


```


Ohad's thirds way, the 
```{r}

# שלב 1: כל מערכת בנפרד
model_front <- multinom(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING, data = FilteredData)
model_lane  <- multinom(as.factor(DEFORMED_LEVEL) ~ LANE_DEPARTURE_WARNING, data = FilteredData)
model_blind <- multinom(as.factor(DEFORMED_LEVEL) ~ BLIND_SPOT_DETECTION, data = FilteredData)

# שלב 2: זוגות
model_front_lane  <- multinom(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + LANE_DEPARTURE_WARNING, data = FilteredData)
model_front_blind <- multinom(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + BLIND_SPOT_DETECTION, data = FilteredData)
model_lane_blind  <- multinom(as.factor(DEFORMED_LEVEL) ~ LANE_DEPARTURE_WARNING + BLIND_SPOT_DETECTION, data = FilteredData)

# שלב 3: כל שלושת המערכות
model_all <- multinom(as.factor(DEFORMED_LEVEL) ~ FRNT_COLLISION_WARNING + LANE_DEPARTURE_WARNING + BLIND_SPOT_DETECTION, data = FilteredData)

cat("Model: Front only\n")
print(summary(model_front))

cat("\n\nModel: Lane only\n")
print(summary(model_lane))

cat("\n\nModel: Blind only\n")
print(summary(model_blind))

cat("\n\nModel: Front + Lane\n")
print(summary(model_front_lane))

cat("\n\nModel: Front + Blind\n")
print(summary(model_front_blind))

cat("\n\nModel: Lane + Blind\n")
print(summary(model_lane_blind))

cat("\n\nModel: All three systems\n")
print(summary(model_all))

```




